<!doctype html>
<html class="no-js" lang="en" data-content_root="../">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="index" title="Index" href="../genindex.html" /><link rel="search" title="Search" href="../search.html" /><link rel="next" title="Usage Guide" href="../migration/index.html" /><link rel="prev" title="Is data loading bottleneck?" href="bottleneck.html" />

    <!-- Generated with Sphinx 7.4.7 and Furo 2024.07.18 -->
        <title>Which stage is the bottleneck? - SPDL 0.0.11 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=8f2a1f02" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo.css?v=613ab9ff" />
    <link rel="stylesheet" type="text/css" href="../_static/collapsible-lists/css/tree_view.css?v=a885cde7" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo-extensions.css?v=302659d7" />
    <link rel="stylesheet" type="text/css" href="../_static/css/custom.css?v=a8e03d5d" />
    
    


<style>
  body {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-SNXS50Q2E3"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-SNXS50Q2E3');
</script>
</head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-with-moon" viewBox="0 0 24 24">
    <title>Auto light/dark, in light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path style="opacity: 50%" d="M 5.411 14.504 C 5.471 14.504 5.532 14.504 5.591 14.504 C 3.639 16.319 4.383 19.569 6.931 20.352 C 7.693 20.586 8.512 20.551 9.25 20.252 C 8.023 23.207 4.056 23.725 2.11 21.184 C 0.166 18.642 1.702 14.949 4.874 14.536 C 5.051 14.512 5.231 14.5 5.411 14.5 L 5.411 14.504 Z"/>
      <line x1="14.5" y1="3.25" x2="14.5" y2="1.25"/>
      <line x1="14.5" y1="15.85" x2="14.5" y2="17.85"/>
      <line x1="10.044" y1="5.094" x2="8.63" y2="3.68"/>
      <line x1="19" y1="14.05" x2="20.414" y2="15.464"/>
      <line x1="8.2" y1="9.55" x2="6.2" y2="9.55"/>
      <line x1="20.8" y1="9.55" x2="22.8" y2="9.55"/>
      <line x1="10.044" y1="14.006" x2="8.63" y2="15.42"/>
      <line x1="19" y1="5.05" x2="20.414" y2="3.636"/>
      <circle cx="14.5" cy="9.55" r="3.6"/>
    </svg>
  </symbol>
  <symbol id="svg-moon-with-sun" viewBox="0 0 24 24">
    <title>Auto light/dark, in dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path d="M 8.282 7.007 C 8.385 7.007 8.494 7.007 8.595 7.007 C 5.18 10.184 6.481 15.869 10.942 17.24 C 12.275 17.648 13.706 17.589 15 17.066 C 12.851 22.236 5.91 23.143 2.505 18.696 C -0.897 14.249 1.791 7.786 7.342 7.063 C 7.652 7.021 7.965 7 8.282 7 L 8.282 7.007 Z"/>
      <line style="opacity: 50%" x1="18" y1="3.705" x2="18" y2="2.5"/>
      <line style="opacity: 50%" x1="18" y1="11.295" x2="18" y2="12.5"/>
      <line style="opacity: 50%" x1="15.316" y1="4.816" x2="14.464" y2="3.964"/>
      <line style="opacity: 50%" x1="20.711" y1="10.212" x2="21.563" y2="11.063"/>
      <line style="opacity: 50%" x1="14.205" y1="7.5" x2="13.001" y2="7.5"/>
      <line style="opacity: 50%" x1="21.795" y1="7.5" x2="23" y2="7.5"/>
      <line style="opacity: 50%" x1="15.316" y1="10.184" x2="14.464" y2="11.036"/>
      <line style="opacity: 50%" x1="20.711" y1="4.789" x2="21.563" y2="3.937"/>
      <circle style="opacity: 50%" cx="18" cy="7.5" r="2.169"/>
    </svg>
  </symbol>
  <symbol id="svg-pencil" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-pencil-code">
      <path d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4" />
      <path d="M13.5 6.5l4 4" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
  <symbol id="svg-eye" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-eye-code">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
      <path
        d="M11.11 17.958c-3.209 -.307 -5.91 -2.293 -8.11 -5.958c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6c-.21 .352 -.427 .688 -.647 1.008" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>

<a class="skip-to-content muted-link" href="#furo-main-content">Skip to content</a>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../index.html"><div class="brand">SPDL 0.0.11 documentation</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
          <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../index.html">
  
  
  <span class="sidebar-brand-text">SPDL 0.0.11 documentation</span>
  
</a><form class="sidebar-search-container" method="get" action="../search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <ul>
<li class="toctree-l1"><a class="reference internal" href="../index.html">Home</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Contents</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Installation</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../getting_started/index.html">Getting Started</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><div class="visually-hidden">Toggle navigation of Getting Started</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../getting_started/intro.html">Building and Running Pipeline</a></li>
<li class="toctree-l2"><a class="reference internal" href="../getting_started/stages.html">Pipeline Stages</a></li>
<li class="toctree-l2"><a class="reference internal" href="../getting_started/concurrency.html">Concurrency</a></li>
</ul>
</li>
<li class="toctree-l1 current has-children"><a class="reference internal" href="index.html">Performance Analysis</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><div class="visually-hidden">Toggle navigation of Performance Analysis</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="bottleneck.html">Is data loading bottleneck?</a></li>
<li class="toctree-l2 current current-page"><a class="current reference internal" href="#">Which stage is the bottleneck?</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../migration/index.html">Usage Guide</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" role="switch" type="checkbox"/><label for="toctree-checkbox-3"><div class="visually-hidden">Toggle navigation of Usage Guide</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../migration/why.html">Why try SPDL?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../migration/paradigm_shift.html">Paradigm Shift</a></li>
<li class="toctree-l2"><a class="reference internal" href="../migration/pytorch.html">Practical Example</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../best_practice.html">Best Practices</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../examples.html">Examples</a><input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" role="switch" type="checkbox"/><label for="toctree-checkbox-4"><div class="visually-hidden">Toggle navigation of Examples</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../generated/image_dataloading.html">image_dataloading</a></li>
<li class="toctree-l2"><a class="reference internal" href="../generated/video_dataloading.html">video_dataloading</a></li>
<li class="toctree-l2"><a class="reference internal" href="../generated/imagenet_classification.html">imagenet_classification</a></li>
<li class="toctree-l2"><a class="reference internal" href="../generated/multi_thread_preprocessing.html">multi_thread_preprocessing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../generated/streaming_nvdec_decoding.html">streaming_nvdec_decoding</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../faq.html">Frequently Asked Questions</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API References</span></p>
<ul>
<li class="toctree-l1 has-children"><a class="reference internal" href="../api.html">API Reference</a><input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" role="switch" type="checkbox"/><label for="toctree-checkbox-5"><div class="visually-hidden">Toggle navigation of API Reference</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../generated/spdl.pipeline.html">spdl.pipeline</a></li>
<li class="toctree-l2"><a class="reference internal" href="../generated/spdl.dataloader.html">spdl.dataloader</a></li>
<li class="toctree-l2"><a class="reference internal" href="../generated/spdl.source.html">spdl.source</a></li>
<li class="toctree-l2"><a class="reference internal" href="../generated/spdl.io.html">spdl.io</a></li>
<li class="toctree-l2"><a class="reference internal" href="../generated/spdl.io.utils.html">spdl.io.utils</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../cpp.html">API Reference (C++)</a><input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" role="switch" type="checkbox"/><label for="toctree-checkbox-6"><div class="visually-hidden">Toggle navigation of API Reference (C++)</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../generated/libspdl/libspdl_class.html">Class List</a></li>
<li class="toctree-l2"><a class="reference internal" href="../generated/libspdl/libspdl_file.html">File List</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../generated/libspdl/libspdl_api.html">API</a><input class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" role="switch" type="checkbox"/><label for="toctree-checkbox-7"><div class="visually-hidden">Toggle navigation of API</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../generated/libspdl/namespace_spdl.html">Namespace spdl</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated/libspdl/namespace_spdl__core.html">Namespace spdl::core</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated/libspdl/namespace_spdl__core__detail.html">Namespace spdl::core::detail</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated/libspdl/namespace_std.html">Namespace std</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated/libspdl/structAVRational.html">Struct AVRational</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated/libspdl/structspdl_1_1core_1_1BytesAdaptor.html">Struct BytesAdaptor</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated/libspdl/structspdl_1_1core_1_1CPUBuffer.html">Struct CPUBuffer</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated/libspdl/structspdl_1_1core_1_1DataInterface.html">Struct DataInterface</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated/libspdl/structspdl_1_1core_1_1DecodeConfig.html">Struct DecodeConfig</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated/libspdl/structspdl_1_1core_1_1DemuxConfig.html">Struct DemuxConfig</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated/libspdl/structspdl_1_1core_1_1EncodeConfig.html">Struct EncodeConfig</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated/libspdl/structspdl_1_1core_1_1EncodeConfigBase.html">Template Struct EncodeConfigBase</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated/libspdl/structspdl_1_1core_1_1Generator.html">Template Struct Generator</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated/libspdl/structspdl_1_1core_1_1Generator_1_1promise__type.html">Struct Generator::promise_type</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated/libspdl/structspdl_1_1core_1_1Packets.html">Template Struct Packets</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated/libspdl/structspdl_1_1core_1_1RawPacketData.html">Struct RawPacketData</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated/libspdl/structspdl_1_1core_1_1SourceAdaptor.html">Struct SourceAdaptor</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated/libspdl/structspdl_1_1core_1_1Storage.html">Struct Storage</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated/libspdl/classspdl_1_1core_1_1Codec.html">Template Class Codec</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated/libspdl/classspdl_1_1core_1_1CPUStorage.html">Class CPUStorage</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated/libspdl/classspdl_1_1core_1_1Decoder.html">Template Class Decoder</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated/libspdl/classspdl_1_1core_1_1Demuxer.html">Class Demuxer</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated/libspdl/classspdl_1_1core_1_1detail_1_1DecoderImpl.html">Template Class DecoderImpl</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated/libspdl/classspdl_1_1core_1_1detail_1_1EncoderImpl.html">Template Class EncoderImpl</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated/libspdl/classspdl_1_1core_1_1Encoder.html">Template Class Encoder</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated/libspdl/classspdl_1_1core_1_1FilterGraph.html">Class FilterGraph</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated/libspdl/classspdl_1_1core_1_1Frames.html">Template Class Frames</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated/libspdl/classspdl_1_1core_1_1InternalError.html">Class InternalError</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated/libspdl/classspdl_1_1core_1_1Muxer.html">Class Muxer</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated/libspdl/classspdl_1_1core_1_1PacketSeries.html">Class PacketSeries</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated/libspdl/classspdl_1_1core_1_1StreamingDemuxer.html">Class StreamingDemuxer</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated/libspdl/classspdl_1_1core_1_1TracingSession.html">Class TracingSession</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated/libspdl/enum_types_8h_1a5422694500d2203e301dc182e5f63d22.html">Enum CodecID</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated/libspdl/enum_types_8h_1adb4e1adb2b3a59148c2797f903ead06f.html">Enum ElemClass</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated/libspdl/enum_types_8h_1ac22438cfd069f0b1b6a736e73e8d244c.html">Enum MediaType</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated/libspdl/function_demuxing_8h_1a4e41f148ebcb2f3132582668ec39ba10.html">Function spdl::core::apply_bsf</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated/libspdl/function_frames_8h_1a30fbfab5f9ecfb208928ebdaca7f4349.html">Template Function spdl::core::clone</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated/libspdl/function_conversion_8h_1a3f08ca7a5c09ab82603e239e50dff4d7.html">Template Function spdl::core::convert_frames(const std::vector&lt;const Frames&lt;media&gt; *&gt;&amp;, std::shared_ptr&lt;CPUStorage&gt;)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated/libspdl/function_conversion_8h_1ae55bfac2f391205603d77241fc25ca1a.html">Template Function spdl::core::convert_frames(const Frames&lt;media&gt; *, std::shared_ptr&lt;CPUStorage&gt;)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated/libspdl/function_conversion_8h_1a773dafcbc30571cc70685702c7020903.html">Function spdl::core::convert_rgb_array</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated/libspdl/function_buffer_8h_1abb668d9a68635211e5e07bd5038df4aa.html">Function spdl::core::cpu_buffer</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated/libspdl/function_encoding_8h_1aa2406e658aea82791bca3e4eddbbd7e0.html">Function spdl::core::encode_image</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated/libspdl/function_packets_8h_1ad3bdea22ad439f82174ce27c26bec857.html">Function spdl::core::extract_packets_at_indices</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated/libspdl/function_utils_8h_1a0aef7b410dcb4075e477b10ba3e71f80.html">Function spdl::core::get_ffmpeg_filters</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated/libspdl/function_utils_8h_1ae1a3d30b33d837c39c40190e681d37c8.html">Function spdl::core::get_ffmpeg_log_level</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated/libspdl/function_utils_8h_1a0ebae69b46f68552c3f64ddc2af67f53.html">Function spdl::core::get_ffmpeg_versions</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated/libspdl/function_packets_8h_1aae5ad1fd09f47a2978afef3921508da0.html">Template Function spdl::core::get_pts</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated/libspdl/function_utils_8h_1af82c781c7484afbad6cbac32ff925793.html">Function spdl::core::init_glog</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated/libspdl/function_utils_8h_1abbebef003881d8734c12e03a47814732.html">Function spdl::core::init_tracing</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated/libspdl/function_demuxing_8h_1ad3fdb02bd04d231cd7238e034c27711f.html">Function spdl::core::make_demuxer(const std::string&amp;, const SourceAdaptorPtr&amp;, const std::optional&lt;DemuxConfig&gt;&amp;)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated/libspdl/function_demuxing_8h_1a590baa95f8eeb6bc0092c723ff060dd4.html">Function spdl::core::make_demuxer(const std::string_view, const std::optional&lt;DemuxConfig&gt;&amp;)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated/libspdl/function_filter__graph_8h_1a54ef17cf7b966b60bb81907e9b0e4c98.html">Function spdl::core::make_filter_graph</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated/libspdl/function_utils_8h_1aa1e91130e5d71e8c2a104e4f72296ff3.html">Function spdl::core::register_avdevices</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated/libspdl/function_utils_8h_1a9b6c16227a1a8445319b487cacb0cd1d.html">Function spdl::core::set_ffmpeg_log_level</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated/libspdl/function_utils_8h_1a893d39670b4169063d8f6e3723f4bc11.html">Template Function spdl::core::trace_counter</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated/libspdl/function_utils_8h_1ae27a1cc3e5bfd9997090eb40711cc6c6.html">Function spdl::core::trace_event_begin</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated/libspdl/function_utils_8h_1a8f29c25b417b77e9dfb5a769b418c169.html">Function spdl::core::trace_event_end</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated/libspdl/define_frames_8h_1ac2ad95ac922a100ec27340436eb94940.html">Define _IS_AUDIO</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated/libspdl/define_frames_8h_1ac99c83df576500933a3691deb137be6d.html">Define _IS_IMAGE</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated/libspdl/define_frames_8h_1a9beaa64113e413112d43491ba5c13670.html">Define _IS_VIDEO</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated/libspdl/define_types_8h_1a3a6c4d7f842d451acf8717ce734385f2.html">Define SPDL_DEFAULT_BUFFER_SIZE</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated/libspdl/typedef_types_8h_1a6eff035c271caa5a533987a1e00ad43e.html">Typedef AVRational</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated/libspdl/typedef_frames_8h_1aba3a9982b74abb6be181dc4d247d53fa.html">Typedef spdl::core::AnyFrames</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated/libspdl/typedef_packets_8h_1ab96da01bb9cc9793e8ae2637e1dd610b.html">Typedef spdl::core::AnyPackets</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated/libspdl/typedef_codec_8h_1a9098e05b01da4afd02090b0d6d7624ba.html">Typedef spdl::core::AudioCodec</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated/libspdl/typedef_types_8h_1a23b168da4cdf96923387b92a43f20038.html">Typedef spdl::core::AudioEncodeConfig</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated/libspdl/typedef_encoder_8h_1a57216492ce017017647dba9d1f6f2a5d.html">Typedef spdl::core::AudioEncoder</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated/libspdl/typedef_encoder_8h_1a0dfcc06d4bbea67c7f45399be8719fa6.html">Typedef spdl::core::AudioEncoderPtr</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated/libspdl/typedef_frames_8h_1a5be56dffe8f2b76de9540fb1ad8b83bf.html">Typedef spdl::core::AudioFrames</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated/libspdl/typedef_frames_8h_1a9db8234daca15eb073d00fa762641b62.html">Typedef spdl::core::AudioFramesPtr</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated/libspdl/typedef_packets_8h_1a9644f8aa13f0e4db02d8ab60673563a3.html">Typedef spdl::core::AudioPackets</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated/libspdl/typedef_packets_8h_1ab2cc72fb6b931466960bd4b9f812784c.html">Typedef spdl::core::AudioPacketsPtr</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated/libspdl/typedef_buffer_8h_1ab6e5b43497adbd35e9fbc35cf5be7101.html">Typedef spdl::core::CPUBufferPtr</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated/libspdl/typedef_adaptor_8h_1adcb670a31326eb24268b384396736cd6.html">Typedef spdl::core::DataInterfacePtr</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated/libspdl/typedef_decoder_8h_1a4b0502ea20d1dda958a67deeb582a74b.html">Typedef spdl::core::DecoderPtr</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated/libspdl/typedef_demuxing_8h_1a4b53016f9b756cc2c2cfbd0e5ad9558b.html">Typedef spdl::core::DemuxerPtr</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated/libspdl/typedef_encoder_8h_1aacfba556b86e2d663a004b8677567339.html">Typedef spdl::core::EncoderPtr</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated/libspdl/typedef_filter__graph_8h_1a29554b40f89e4b227521ff86ccf69b8b.html">Typedef spdl::core::FilterGraphPtr</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated/libspdl/typedef_frames_8h_1ad628496b3863230dd76eeccc4fa66437.html">Typedef spdl::core::FramesPtr</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated/libspdl/typedef_codec_8h_1a606d432c7b033a787f653c4992937e6f.html">Typedef spdl::core::ImageCodec</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated/libspdl/typedef_frames_8h_1a53a3c93ef56a4400fabd3a553ab21c4a.html">Typedef spdl::core::ImageFrames</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated/libspdl/typedef_frames_8h_1a3760130bba382ba7f15df177ca3374c7.html">Typedef spdl::core::ImageFramesPtr</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated/libspdl/typedef_packets_8h_1af018ade1cd38831c342686abbcb787a8.html">Typedef spdl::core::ImagePackets</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated/libspdl/typedef_packets_8h_1a8b9c8b08fcbf891fa939700ecd807ce1.html">Typedef spdl::core::ImagePacketsPtr</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated/libspdl/typedef_muxer_8h_1aaa76352d246819df02bc407729f69dda.html">Typedef spdl::core::MuxerPtr</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated/libspdl/typedef_types_8h_1aa5d8175da6bbcbe93e7191461f7baa20.html">Typedef spdl::core::OptionDict</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated/libspdl/typedef_packets_8h_1a331b599d0eceb00ebef166d64623c71a.html">Typedef spdl::core::PacketSeriesPtr</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated/libspdl/typedef_packets_8h_1aad5761fe07714efccc2be969a4397354.html">Typedef spdl::core::PacketsPtr</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated/libspdl/typedef_types_8h_1a8bd80c8465b1f3e17b564c5ced977a2d.html">Typedef spdl::core::Rational</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated/libspdl/typedef_adaptor_8h_1adfe58c3c3a3d3171c1d69c2e9924f2a7.html">Typedef spdl::core::SourceAdaptorPtr</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated/libspdl/typedef_demuxing_8h_1a0a7f8c140cd7110dc5f3f6537fae67db.html">Typedef spdl::core::StreamingDemuxerPtr</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated/libspdl/typedef_codec_8h_1ac7441badce2b2aa467eac09b35d4f81e.html">Typedef spdl::core::VideoCodec</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated/libspdl/typedef_types_8h_1a8b310bdb98714a971b07aa58f7403529.html">Typedef spdl::core::VideoEncodeConfig</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated/libspdl/typedef_encoder_8h_1a383bf2b0ac1564702f10e3b5f3ef03f6.html">Typedef spdl::core::VideoEncoder</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated/libspdl/typedef_encoder_8h_1a39ace4ea741767fa3d802040a9bc22e1.html">Typedef spdl::core::VideoEncoderPtr</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated/libspdl/typedef_frames_8h_1af1892953097f3723455403752ef79fc5.html">Typedef spdl::core::VideoFrames</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated/libspdl/typedef_frames_8h_1acb0efeb222082bf955c71c74964d301d.html">Typedef spdl::core::VideoFramesPtr</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated/libspdl/typedef_packets_8h_1a7be7c9faccc623d12fb33ec966f84b4c.html">Typedef spdl::core::VideoPackets</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated/libspdl/typedef_packets_8h_1aa21b44d594bfc132b4252fd2f544a691.html">Typedef spdl::core::VideoPacketsPtr</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../genindex.html">API Index</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Development Notes</span></p>
<ul>
<li class="toctree-l1 has-children"><a class="reference internal" href="../notes/index.html">Development Notes</a><input class="toctree-checkbox" id="toctree-checkbox-8" name="toctree-checkbox-8" role="switch" type="checkbox"/><label for="toctree-checkbox-8"><div class="visually-hidden">Toggle navigation of Development Notes</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../notes/pipeline_impl.html">Implementation detail of Pipeline</a></li>
</ul>
</li>
</ul>

</div>
</div>
<div class="sidebar-tree">
<ul>
  <li class="toctree-l1 has-children">
    <span class="reference">Versions</span>
    <input class="toctree-checkbox" id="toctree-checkbox-versions" name="toctree-checkbox-versions" role="switch" type="checkbox">
    <label for="toctree-checkbox-versions">
      <div class="visually-hidden">Toggle navigattion of Versions</div>
      <i class="icon">
        <svg>
          <use href="#svg-arrow-right"></use>
        </svg>
      </i>
    </label>
    <ul>
      <li class="toctree-l2"><a class="reference internal" href="/spdl/main">dev</a></li>
      <li class="toctree-l2"><a class="reference internal" href="/spdl/latest">latest-release</a></li>
      <li class="toctree-l2"><a class="reference internal" href="/spdl/0.0.10">0.0.10</a></li>
      <li class="toctree-l2"><a class="reference internal" href="/spdl/0.0.9">0.0.9</a></li>
      <li class="toctree-l2"><a class="reference internal" href="/spdl/0.0.8">0.0.8</a></li>
    </ul>
  </li>
</ul>
</div>
      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="view-this-page">
  <a class="muted-link" href="../_sources/performance_analysis/stage_stats.rst.txt" title="View this page">
    <svg><use href="#svg-eye"></use></svg>
    <span class="visually-hidden">View this page</span>
  </a>
</div>
<div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
              <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main" id="furo-main-content">
          <section id="which-stage-is-the-bottleneck">
<h1>Which stage is the bottleneck?<a class="headerlink" href="#which-stage-is-the-bottleneck" title="Link to this heading">¶</a></h1>
<p>By default, when a pipe stage is created, <code class="xref py py-class docutils literal notranslate"><span class="pre">TaskStatsHook</span></code> is attached to the stage.
This hook collects runtime statistics of the stage and report them at the end.
We can use this report to determine which stage in the pipeline is being the bottleneck
thus requires improvement.</p>
<section id="task-stats-and-qps">
<h2>Task Stats and QPS<a class="headerlink" href="#task-stats-and-qps" title="Link to this heading">¶</a></h2>
<p>Let’s say, we have a pipeline that downloads data from remote storage system and process the data.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">pipeline</span> <span class="o">=</span> <span class="p">(</span>
<span class="gp">... </span>    <span class="n">PipelineBuilder</span><span class="p">()</span>
<span class="gp">... </span>    <span class="o">.</span><span class="n">add_source</span><span class="p">(</span><span class="n">sample_list</span><span class="p">)</span>
<span class="gp">... </span>    <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">download</span><span class="p">,</span> <span class="n">concurrency</span><span class="o">=</span><span class="mi">32</span><span class="p">)</span>
<span class="gp">... </span>    <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">process</span><span class="p">,</span> <span class="n">concurrency</span><span class="o">=</span><span class="mi">128</span><span class="p">)</span>
<span class="gp">... </span>    <span class="o">.</span><span class="n">add_sink</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="gp">... </span>    <span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">num_threads</span><span class="o">=</span><span class="mi">128</span><span class="p">)</span>
<span class="gp">... </span><span class="p">)</span>
</pre></div>
</div>
<p>We execute the pipeline without downstream load, and we obtain the following log.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">with</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">auto_stop</span><span class="p">():</span>
<span class="gp">... </span>    <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">pipeline</span><span class="p">:</span>
<span class="gp">... </span>        <span class="k">pass</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">download</span><span class="p">]</span>   <span class="n">Completed</span>  <span class="mi">2559</span> <span class="n">tasks</span> <span class="p">(</span><span class="mi">163</span> <span class="n">failed</span><span class="p">)</span> <span class="ow">in</span> <span class="mf">17.3974</span> <span class="p">[</span><span class="n">sec</span><span class="p">]</span><span class="o">.</span> <span class="n">QPS</span><span class="p">:</span> <span class="mf">137.72</span> <span class="p">(</span><span class="n">Concurrency</span><span class="p">:</span>  <span class="mi">32</span><span class="p">)</span><span class="o">.</span> <span class="n">Average</span> <span class="n">task</span> <span class="n">time</span><span class="p">:</span> <span class="mf">128.7163</span> <span class="p">[</span> <span class="n">ms</span><span class="p">]</span><span class="o">.</span>
<span class="p">[</span><span class="n">process</span><span class="p">]</span>    <span class="n">Completed</span>  <span class="mi">2396</span> <span class="n">tasks</span> <span class="p">(</span>  <span class="mi">0</span> <span class="n">failed</span><span class="p">)</span> <span class="ow">in</span> <span class="mf">18.9318</span> <span class="p">[</span><span class="n">sec</span><span class="p">]</span><span class="o">.</span> <span class="n">QPS</span><span class="p">:</span> <span class="mf">126.56</span> <span class="p">(</span><span class="n">Concurrency</span><span class="p">:</span> <span class="mi">128</span><span class="p">)</span><span class="o">.</span> <span class="n">Average</span> <span class="n">task</span> <span class="n">time</span><span class="p">:</span> <span class="mf">896.3629</span> <span class="p">[</span> <span class="n">ms</span><span class="p">]</span><span class="o">.</span>
</pre></div>
</div>
<p><code class="xref py py-class docutils literal notranslate"><span class="pre">TaskStatsHook</span></code> collects the number of tasks (items processed by the stage), the average task execution time and the time elapsed between the start and the end of the stage.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The average task time does not include the failed tasks, however,
the total duration of the stage include everything from task execution
to the time it waited on input/output queues.</p>
</div>
<p><code class="docutils literal notranslate"><span class="pre">QPS</span></code> (queries per second, though it is not query) is the number of tasks successfully completed, divided by the duration of the stage. It is an indication of how fast the stage is processing items.</p>
<p>From source to the sink, <code class="docutils literal notranslate"><span class="pre">QPS</span></code> can only decrease, as it is impossible for downstream stages to process items faster than upstream stages.
If a downstream stage is fast enough to catch up its upstream stage, then the QPS values are roughly the same between these stages.
If a downstream stage is not as fast as its upstream stage, then the QPS value of the downstream stage is smaller than that of the upstream stage.</p>
<p>Therefore, by locating the stage at which QPS drops significantly, we can determine the stage which is the bottleneck within the pipeline.</p>
<p>In the above example, QPS drops from 137 to 126 in the <code class="docutils literal notranslate"><span class="pre">process</span></code> stage. This indicates that data processing is not up to the speed of data acquisition. To optimize the pipeline throughput, one needs to improve the performance of the <code class="docutils literal notranslate"><span class="pre">process</span></code> stage. Increasing the throughput of the <code class="docutils literal notranslate"><span class="pre">download</span></code> stage does not help. How to optimize the <code class="docutils literal notranslate"><span class="pre">process</span></code> stage depends on the other factors. For example if the machine executing the pipeline has spare computation resource, then increasing the concurrency and the number of threads can help.</p>
</section>
<section id="tuning-pipeline-performance">
<h2>Tuning Pipeline Performance<a class="headerlink" href="#tuning-pipeline-performance" title="Link to this heading">¶</a></h2>
<p>Let’s look at another example.</p>
<p>This time, we download images from the remote source, decode, batch and send them to GPU device. We create decoding/pre-processing and batch stage using <a class="reference internal" href="../generated/spdl.io.html#module-spdl.io" title="spdl.io"><code class="xref py py-mod docutils literal notranslate"><span class="pre">spdl.io</span></code></a>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">def</span><span class="w"> </span><span class="nf">decode</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="mi">224</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">224</span><span class="p">,</span> <span class="n">pix_fmt</span><span class="o">=</span><span class="s2">&quot;rgb24&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">:</span>
<span class="gp">... </span><span class="w">    </span><span class="sd">&quot;&quot;&quot;Decode and resize image from byte string&quot;&quot;&quot;</span>
<span class="gp">... </span>    <span class="n">filter_desc</span> <span class="o">=</span> <span class="n">spdl</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">get_video_filter_desc</span><span class="p">(</span>
<span class="gp">... </span>        <span class="n">scale_width</span><span class="o">=</span><span class="n">width</span><span class="p">,</span> <span class="n">scale_height</span><span class="o">=</span><span class="n">height</span><span class="p">,</span> <span class="n">pix_fmt</span><span class="o">=</span><span class="n">pix_fmt</span>
<span class="gp">... </span>    <span class="p">)</span>
<span class="gp">...</span>
<span class="gp">... </span>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">decode</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Frames</span><span class="p">:</span>
<span class="gp">... </span>        <span class="n">packets</span> <span class="o">=</span> <span class="k">await</span> <span class="n">spdl</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">async_demux_image</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="gp">... </span>        <span class="n">frames</span> <span class="o">=</span> <span class="k">await</span> <span class="n">spdl</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">async_decode_packets</span><span class="p">(</span><span class="n">packets</span><span class="p">,</span> <span class="n">filter_desc</span><span class="o">=</span><span class="n">filter_desc</span><span class="p">)</span>
<span class="gp">... </span>        <span class="k">return</span> <span class="n">frames</span>
<span class="gp">...</span>
<span class="gp">... </span>    <span class="k">return</span> <span class="n">decode</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">batchify</span><span class="p">(</span><span class="n">frames</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Frames</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="gp">... </span><span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a batch from image frames, send them to GPU and create Torch tensor&quot;&quot;&quot;</span>
<span class="gp">... </span>    <span class="n">cfg</span> <span class="o">=</span> <span class="n">spdl</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">cuda_config</span><span class="p">(</span><span class="n">device_index</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="gp">... </span>    <span class="n">cpu_buffer</span> <span class="o">=</span> <span class="k">await</span> <span class="n">spdl</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">async_convert_frames</span><span class="p">(</span><span class="n">frames</span><span class="p">)</span>
<span class="gp">... </span>    <span class="n">cuda_buffer</span> <span class="o">=</span> <span class="k">await</span> <span class="n">spdl</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">async_transfer_buffer</span><span class="p">(</span><span class="n">cpu_buffer</span><span class="p">,</span> <span class="n">cuda_config</span><span class="o">=</span><span class="n">cfg</span><span class="p">)</span>
<span class="gp">...</span>
<span class="gp">... </span>    <span class="k">return</span> <span class="n">routes</span><span class="p">,</span> <span class="n">spdl</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">to_torch</span><span class="p">(</span><span class="n">cuda_buffer</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">def</span><span class="w"> </span><span class="nf">run_pipeline</span><span class="p">(</span><span class="n">dl_concurrency</span><span class="p">,</span> <span class="n">decode_concurrency</span><span class="p">):</span>
<span class="gp">... </span>    <span class="n">pipeline</span> <span class="o">=</span> <span class="p">(</span>
<span class="gp">... </span>        <span class="n">PipelineBuilder</span><span class="p">()</span>
<span class="gp">... </span>        <span class="o">.</span><span class="n">add_source</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
<span class="gp">... </span>        <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">download</span><span class="p">,</span> <span class="n">concurrency</span><span class="o">=</span><span class="n">dl_concurrency</span><span class="p">)</span>
<span class="gp">... </span>        <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">decode</span><span class="p">(),</span> <span class="n">concurrency</span><span class="o">=</span><span class="n">decode_concurrency</span><span class="p">)</span>
<span class="gp">... </span>        <span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span>
<span class="gp">... </span>        <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">batchify</span><span class="p">)</span>
<span class="gp">... </span>        <span class="o">.</span><span class="n">add_sink</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<span class="gp">... </span>        <span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">num_threads</span><span class="o">=</span><span class="n">decode_concurrency</span><span class="p">)</span>
<span class="gp">... </span>    <span class="p">)</span>
<span class="gp">... </span>    <span class="k">with</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">auto_stop</span><span class="p">():</span>
<span class="gp">... </span>        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">pipeline</span><span class="p">:</span>
<span class="gp">... </span>            <span class="k">pass</span>
</pre></div>
</div>
<p>Now we run the pipeline with different concurrency values for downloading and decoding.
(You can skip the raw result and go to the summary table bellow.)</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">run_pipeline</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">download</span><span class="p">]</span>   <span class="n">Completed</span>  <span class="mi">1600</span> <span class="n">tasks</span> <span class="p">(</span>  <span class="mi">0</span> <span class="n">failed</span><span class="p">)</span> <span class="ow">in</span> <span class="mf">6.2723</span> <span class="p">[</span><span class="n">sec</span><span class="p">]</span><span class="o">.</span> <span class="n">QPS</span><span class="p">:</span> <span class="mf">255.09</span> <span class="p">(</span><span class="n">Concurrency</span><span class="p">:</span>  <span class="mi">64</span><span class="p">)</span><span class="o">.</span> <span class="n">Average</span> <span class="n">task</span> <span class="n">time</span><span class="p">:</span> <span class="mf">240.2614</span> <span class="p">[</span> <span class="n">ms</span><span class="p">]</span><span class="o">.</span>
<span class="p">[</span><span class="n">decode_image</span><span class="p">]</span>       <span class="n">Completed</span>  <span class="mi">1600</span> <span class="n">tasks</span> <span class="p">(</span>  <span class="mi">0</span> <span class="n">failed</span><span class="p">)</span> <span class="ow">in</span> <span class="mf">6.2763</span> <span class="p">[</span><span class="n">sec</span><span class="p">]</span><span class="o">.</span> <span class="n">QPS</span><span class="p">:</span> <span class="mf">254.93</span> <span class="p">(</span><span class="n">Concurrency</span><span class="p">:</span>   <span class="mi">4</span><span class="p">)</span><span class="o">.</span> <span class="n">Average</span> <span class="n">task</span> <span class="n">time</span><span class="p">:</span> <span class="mf">3.8516</span> <span class="p">[</span> <span class="n">ms</span><span class="p">]</span><span class="o">.</span>
<span class="p">[</span><span class="n">aggregate</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="n">drop_last</span><span class="o">=</span><span class="kc">False</span><span class="p">)]</span>     <span class="n">Completed</span>  <span class="mi">1601</span> <span class="n">tasks</span> <span class="p">(</span>  <span class="mi">0</span> <span class="n">failed</span><span class="p">)</span> <span class="ow">in</span> <span class="mf">6.2786</span> <span class="p">[</span><span class="n">sec</span><span class="p">]</span><span class="o">.</span> <span class="n">QPS</span><span class="p">:</span> <span class="mf">254.99</span> <span class="p">(</span><span class="n">Concurrency</span><span class="p">:</span>   <span class="mi">1</span><span class="p">)</span><span class="o">.</span> <span class="n">Average</span> <span class="n">task</span> <span class="n">time</span><span class="p">:</span> <span class="mf">0.0038</span> <span class="p">[</span> <span class="n">ms</span><span class="p">]</span><span class="o">.</span>
<span class="p">[</span><span class="n">batchify</span><span class="p">]</span>   <span class="n">Completed</span>    <span class="mi">50</span> <span class="n">tasks</span> <span class="p">(</span>  <span class="mi">0</span> <span class="n">failed</span><span class="p">)</span> <span class="ow">in</span> <span class="mf">6.2790</span> <span class="p">[</span><span class="n">sec</span><span class="p">]</span><span class="o">.</span> <span class="n">QPS</span><span class="p">:</span> <span class="mf">7.96</span> <span class="p">(</span><span class="n">Concurrency</span><span class="p">:</span>   <span class="mi">1</span><span class="p">)</span><span class="o">.</span> <span class="n">Average</span> <span class="n">task</span> <span class="n">time</span><span class="p">:</span> <span class="mf">1.6127</span> <span class="p">[</span> <span class="n">ms</span><span class="p">]</span><span class="o">.</span>
<span class="p">[</span><span class="n">sink</span><span class="p">]</span>       <span class="n">Processed</span>    <span class="mi">50</span> <span class="n">items</span> <span class="ow">in</span> <span class="mf">6.2799</span> <span class="p">[</span><span class="n">sec</span><span class="p">]</span><span class="o">.</span> <span class="n">QPS</span><span class="p">:</span> <span class="mf">7.96</span><span class="o">.</span> <span class="n">Average</span> <span class="n">wait</span> <span class="n">time</span><span class="p">:</span> <span class="n">Upstream</span><span class="p">:</span> <span class="mf">123.1203</span> <span class="p">[</span><span class="n">ms</span> <span class="p">],</span> <span class="n">Downstream</span><span class="p">:</span> <span class="mf">0.0043</span> <span class="p">[</span><span class="n">ms</span> <span class="p">]</span><span class="o">.</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">run_pipeline</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">download</span><span class="p">]</span>   <span class="n">Completed</span>  <span class="mi">1600</span> <span class="n">tasks</span> <span class="p">(</span>  <span class="mi">0</span> <span class="n">failed</span><span class="p">)</span> <span class="ow">in</span> <span class="mf">2.0347</span> <span class="p">[</span><span class="n">sec</span><span class="p">]</span><span class="o">.</span> <span class="n">QPS</span><span class="p">:</span> <span class="mf">786.36</span> <span class="p">(</span><span class="n">Concurrency</span><span class="p">:</span> <span class="mi">128</span><span class="p">)</span><span class="o">.</span> <span class="n">Average</span> <span class="n">task</span> <span class="n">time</span><span class="p">:</span> <span class="mf">139.2847</span> <span class="p">[</span> <span class="n">ms</span><span class="p">]</span><span class="o">.</span>
<span class="p">[</span><span class="n">decode_image</span><span class="p">]</span>       <span class="n">Completed</span>  <span class="mi">1600</span> <span class="n">tasks</span> <span class="p">(</span>  <span class="mi">0</span> <span class="n">failed</span><span class="p">)</span> <span class="ow">in</span> <span class="mf">2.0385</span> <span class="p">[</span><span class="n">sec</span><span class="p">]</span><span class="o">.</span> <span class="n">QPS</span><span class="p">:</span> <span class="mf">784.89</span> <span class="p">(</span><span class="n">Concurrency</span><span class="p">:</span>   <span class="mi">4</span><span class="p">)</span><span class="o">.</span> <span class="n">Average</span> <span class="n">task</span> <span class="n">time</span><span class="p">:</span> <span class="mf">4.1260</span> <span class="p">[</span> <span class="n">ms</span><span class="p">]</span><span class="o">.</span>
<span class="p">[</span><span class="n">aggregate</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="n">drop_last</span><span class="o">=</span><span class="kc">False</span><span class="p">)]</span>     <span class="n">Completed</span>  <span class="mi">1601</span> <span class="n">tasks</span> <span class="p">(</span>  <span class="mi">0</span> <span class="n">failed</span><span class="p">)</span> <span class="ow">in</span> <span class="mf">2.0477</span> <span class="p">[</span><span class="n">sec</span><span class="p">]</span><span class="o">.</span> <span class="n">QPS</span><span class="p">:</span> <span class="mf">781.87</span> <span class="p">(</span><span class="n">Concurrency</span><span class="p">:</span>   <span class="mi">1</span><span class="p">)</span><span class="o">.</span> <span class="n">Average</span> <span class="n">task</span> <span class="n">time</span><span class="p">:</span> <span class="mf">0.0039</span> <span class="p">[</span> <span class="n">ms</span><span class="p">]</span><span class="o">.</span>
<span class="p">[</span><span class="n">batchify</span><span class="p">]</span>   <span class="n">Completed</span>    <span class="mi">50</span> <span class="n">tasks</span> <span class="p">(</span>  <span class="mi">0</span> <span class="n">failed</span><span class="p">)</span> <span class="ow">in</span> <span class="mf">2.0522</span> <span class="p">[</span><span class="n">sec</span><span class="p">]</span><span class="o">.</span> <span class="n">QPS</span><span class="p">:</span> <span class="mf">24.36</span> <span class="p">(</span><span class="n">Concurrency</span><span class="p">:</span>   <span class="mi">1</span><span class="p">)</span><span class="o">.</span> <span class="n">Average</span> <span class="n">task</span> <span class="n">time</span><span class="p">:</span> <span class="mf">2.6672</span> <span class="p">[</span> <span class="n">ms</span><span class="p">]</span><span class="o">.</span>
<span class="p">[</span><span class="n">sink</span><span class="p">]</span>       <span class="n">Processed</span>    <span class="mi">50</span> <span class="n">items</span> <span class="ow">in</span> <span class="mf">2.0529</span> <span class="p">[</span><span class="n">sec</span><span class="p">]</span><span class="o">.</span> <span class="n">QPS</span><span class="p">:</span> <span class="mf">24.36</span><span class="o">.</span> <span class="n">Average</span> <span class="n">wait</span> <span class="n">time</span><span class="p">:</span> <span class="n">Upstream</span><span class="p">:</span> <span class="mf">40.2405</span> <span class="p">[</span><span class="n">ms</span> <span class="p">],</span> <span class="n">Downstream</span><span class="p">:</span> <span class="mf">0.0040</span> <span class="p">[</span><span class="n">ms</span> <span class="p">]</span><span class="o">.</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">run_pipeline</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">download</span><span class="p">]</span>   <span class="n">Completed</span>  <span class="mi">1600</span> <span class="n">tasks</span> <span class="p">(</span>  <span class="mi">0</span> <span class="n">failed</span><span class="p">)</span> <span class="ow">in</span> <span class="mf">1.8855</span> <span class="p">[</span><span class="n">sec</span><span class="p">]</span><span class="o">.</span> <span class="n">QPS</span><span class="p">:</span> <span class="mf">848.57</span> <span class="p">(</span><span class="n">Concurrency</span><span class="p">:</span> <span class="mi">256</span><span class="p">)</span><span class="o">.</span> <span class="n">Average</span> <span class="n">task</span> <span class="n">time</span><span class="p">:</span> <span class="mf">146.4174</span> <span class="p">[</span> <span class="n">ms</span><span class="p">]</span><span class="o">.</span>
<span class="p">[</span><span class="n">decode_image</span><span class="p">]</span>       <span class="n">Completed</span>  <span class="mi">1600</span> <span class="n">tasks</span> <span class="p">(</span>  <span class="mi">0</span> <span class="n">failed</span><span class="p">)</span> <span class="ow">in</span> <span class="mf">1.8907</span> <span class="p">[</span><span class="n">sec</span><span class="p">]</span><span class="o">.</span> <span class="n">QPS</span><span class="p">:</span> <span class="mf">846.25</span> <span class="p">(</span><span class="n">Concurrency</span><span class="p">:</span>   <span class="mi">4</span><span class="p">)</span><span class="o">.</span> <span class="n">Average</span> <span class="n">task</span> <span class="n">time</span><span class="p">:</span> <span class="mf">4.3023</span> <span class="p">[</span> <span class="n">ms</span><span class="p">]</span><span class="o">.</span>
<span class="p">[</span><span class="n">aggregate</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="n">drop_last</span><span class="o">=</span><span class="kc">False</span><span class="p">)]</span>     <span class="n">Completed</span>  <span class="mi">1601</span> <span class="n">tasks</span> <span class="p">(</span>  <span class="mi">0</span> <span class="n">failed</span><span class="p">)</span> <span class="ow">in</span> <span class="mf">1.8935</span> <span class="p">[</span><span class="n">sec</span><span class="p">]</span><span class="o">.</span> <span class="n">QPS</span><span class="p">:</span> <span class="mf">845.52</span> <span class="p">(</span><span class="n">Concurrency</span><span class="p">:</span>   <span class="mi">1</span><span class="p">)</span><span class="o">.</span> <span class="n">Average</span> <span class="n">task</span> <span class="n">time</span><span class="p">:</span> <span class="mf">0.0038</span> <span class="p">[</span> <span class="n">ms</span><span class="p">]</span><span class="o">.</span>
<span class="p">[</span><span class="n">batchify</span><span class="p">]</span>   <span class="n">Completed</span>    <span class="mi">50</span> <span class="n">tasks</span> <span class="p">(</span>  <span class="mi">0</span> <span class="n">failed</span><span class="p">)</span> <span class="ow">in</span> <span class="mf">1.8942</span> <span class="p">[</span><span class="n">sec</span><span class="p">]</span><span class="o">.</span> <span class="n">QPS</span><span class="p">:</span> <span class="mf">26.40</span> <span class="p">(</span><span class="n">Concurrency</span><span class="p">:</span>   <span class="mi">1</span><span class="p">)</span><span class="o">.</span> <span class="n">Average</span> <span class="n">task</span> <span class="n">time</span><span class="p">:</span> <span class="mf">2.6016</span> <span class="p">[</span> <span class="n">ms</span><span class="p">]</span><span class="o">.</span>
<span class="p">[</span><span class="n">sink</span><span class="p">]</span>       <span class="n">Processed</span>    <span class="mi">50</span> <span class="n">items</span> <span class="ow">in</span> <span class="mf">1.8945</span> <span class="p">[</span><span class="n">sec</span><span class="p">]</span><span class="o">.</span> <span class="n">QPS</span><span class="p">:</span> <span class="mf">26.39</span><span class="o">.</span> <span class="n">Average</span> <span class="n">wait</span> <span class="n">time</span><span class="p">:</span> <span class="n">Upstream</span><span class="p">:</span> <span class="mf">37.1349</span> <span class="p">[</span><span class="n">ms</span> <span class="p">],</span> <span class="n">Downstream</span><span class="p">:</span> <span class="mf">0.0039</span> <span class="p">[</span><span class="n">ms</span> <span class="p">]</span><span class="o">.</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">run_pipeline</span><span class="p">(</span><span class="mi">512</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">download</span><span class="p">]</span>   <span class="n">Completed</span>  <span class="mi">1600</span> <span class="n">tasks</span> <span class="p">(</span>  <span class="mi">0</span> <span class="n">failed</span><span class="p">)</span> <span class="ow">in</span> <span class="mf">1.9942</span> <span class="p">[</span><span class="n">sec</span><span class="p">]</span><span class="o">.</span> <span class="n">QPS</span><span class="p">:</span> <span class="mf">802.31</span> <span class="p">(</span><span class="n">Concurrency</span><span class="p">:</span> <span class="mi">512</span><span class="p">)</span><span class="o">.</span> <span class="n">Average</span> <span class="n">task</span> <span class="n">time</span><span class="p">:</span> <span class="mf">151.8697</span> <span class="p">[</span> <span class="n">ms</span><span class="p">]</span><span class="o">.</span>
<span class="p">[</span><span class="n">decode_image</span><span class="p">]</span>       <span class="n">Completed</span>  <span class="mi">1600</span> <span class="n">tasks</span> <span class="p">(</span>  <span class="mi">0</span> <span class="n">failed</span><span class="p">)</span> <span class="ow">in</span> <span class="mf">1.9986</span> <span class="p">[</span><span class="n">sec</span><span class="p">]</span><span class="o">.</span> <span class="n">QPS</span><span class="p">:</span> <span class="mf">800.55</span> <span class="p">(</span><span class="n">Concurrency</span><span class="p">:</span>   <span class="mi">4</span><span class="p">)</span><span class="o">.</span> <span class="n">Average</span> <span class="n">task</span> <span class="n">time</span><span class="p">:</span> <span class="mf">4.5500</span> <span class="p">[</span> <span class="n">ms</span><span class="p">]</span><span class="o">.</span>
<span class="p">[</span><span class="n">aggregate</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="n">drop_last</span><span class="o">=</span><span class="kc">False</span><span class="p">)]</span>     <span class="n">Completed</span>  <span class="mi">1601</span> <span class="n">tasks</span> <span class="p">(</span>  <span class="mi">0</span> <span class="n">failed</span><span class="p">)</span> <span class="ow">in</span> <span class="mf">2.0021</span> <span class="p">[</span><span class="n">sec</span><span class="p">]</span><span class="o">.</span> <span class="n">QPS</span><span class="p">:</span> <span class="mf">799.67</span> <span class="p">(</span><span class="n">Concurrency</span><span class="p">:</span>   <span class="mi">1</span><span class="p">)</span><span class="o">.</span> <span class="n">Average</span> <span class="n">task</span> <span class="n">time</span><span class="p">:</span> <span class="mf">0.0038</span> <span class="p">[</span> <span class="n">ms</span><span class="p">]</span><span class="o">.</span>
<span class="p">[</span><span class="n">batchify</span><span class="p">]</span>   <span class="n">Completed</span>    <span class="mi">50</span> <span class="n">tasks</span> <span class="p">(</span>  <span class="mi">0</span> <span class="n">failed</span><span class="p">)</span> <span class="ow">in</span> <span class="mf">2.0029</span> <span class="p">[</span><span class="n">sec</span><span class="p">]</span><span class="o">.</span> <span class="n">QPS</span><span class="p">:</span> <span class="mf">24.96</span> <span class="p">(</span><span class="n">Concurrency</span><span class="p">:</span>   <span class="mi">1</span><span class="p">)</span><span class="o">.</span> <span class="n">Average</span> <span class="n">task</span> <span class="n">time</span><span class="p">:</span> <span class="mf">3.1626</span> <span class="p">[</span> <span class="n">ms</span><span class="p">]</span><span class="o">.</span>
<span class="p">[</span><span class="n">sink</span><span class="p">]</span>       <span class="n">Processed</span>    <span class="mi">50</span> <span class="n">items</span> <span class="ow">in</span> <span class="mf">2.0037</span> <span class="p">[</span><span class="n">sec</span><span class="p">]</span><span class="o">.</span> <span class="n">QPS</span><span class="p">:</span> <span class="mf">24.95</span><span class="o">.</span> <span class="n">Average</span> <span class="n">wait</span> <span class="n">time</span><span class="p">:</span> <span class="n">Upstream</span><span class="p">:</span> <span class="mf">39.2747</span> <span class="p">[</span><span class="n">ms</span> <span class="p">],</span> <span class="n">Downstream</span><span class="p">:</span> <span class="mf">0.0044</span> <span class="p">[</span><span class="n">ms</span> <span class="p">]</span><span class="o">.</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">run_pipeline</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">download</span><span class="p">]</span>   <span class="n">Completed</span>  <span class="mi">1600</span> <span class="n">tasks</span> <span class="p">(</span>  <span class="mi">0</span> <span class="n">failed</span><span class="p">)</span> <span class="ow">in</span> <span class="mf">1.3731</span> <span class="p">[</span><span class="n">sec</span><span class="p">]</span><span class="o">.</span> <span class="n">QPS</span><span class="p">:</span> <span class="mf">1165.27</span> <span class="p">(</span><span class="n">Concurrency</span><span class="p">:</span> <span class="mi">256</span><span class="p">)</span><span class="o">.</span> <span class="n">Average</span> <span class="n">task</span> <span class="n">time</span><span class="p">:</span> <span class="mf">152.5442</span> <span class="p">[</span> <span class="n">ms</span><span class="p">]</span><span class="o">.</span>
<span class="p">[</span><span class="n">decode_image</span><span class="p">]</span>       <span class="n">Completed</span>  <span class="mi">1600</span> <span class="n">tasks</span> <span class="p">(</span>  <span class="mi">0</span> <span class="n">failed</span><span class="p">)</span> <span class="ow">in</span> <span class="mf">1.3768</span> <span class="p">[</span><span class="n">sec</span><span class="p">]</span><span class="o">.</span> <span class="n">QPS</span><span class="p">:</span> <span class="mf">1162.10</span> <span class="p">(</span><span class="n">Concurrency</span><span class="p">:</span>   <span class="mi">8</span><span class="p">)</span><span class="o">.</span> <span class="n">Average</span> <span class="n">task</span> <span class="n">time</span><span class="p">:</span> <span class="mf">5.4827</span> <span class="p">[</span> <span class="n">ms</span><span class="p">]</span><span class="o">.</span>
<span class="p">[</span><span class="n">aggregate</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="n">drop_last</span><span class="o">=</span><span class="kc">False</span><span class="p">)]</span>     <span class="n">Completed</span>  <span class="mi">1601</span> <span class="n">tasks</span> <span class="p">(</span>  <span class="mi">0</span> <span class="n">failed</span><span class="p">)</span> <span class="ow">in</span> <span class="mf">1.3794</span> <span class="p">[</span><span class="n">sec</span><span class="p">]</span><span class="o">.</span> <span class="n">QPS</span><span class="p">:</span> <span class="mf">1160.61</span> <span class="p">(</span><span class="n">Concurrency</span><span class="p">:</span>   <span class="mi">1</span><span class="p">)</span><span class="o">.</span> <span class="n">Average</span> <span class="n">task</span> <span class="n">time</span><span class="p">:</span> <span class="mf">0.0038</span> <span class="p">[</span> <span class="n">ms</span><span class="p">]</span><span class="o">.</span>
<span class="p">[</span><span class="n">batchify</span><span class="p">]</span>   <span class="n">Completed</span>    <span class="mi">50</span> <span class="n">tasks</span> <span class="p">(</span>  <span class="mi">0</span> <span class="n">failed</span><span class="p">)</span> <span class="ow">in</span> <span class="mf">1.3806</span> <span class="p">[</span><span class="n">sec</span><span class="p">]</span><span class="o">.</span> <span class="n">QPS</span><span class="p">:</span> <span class="mf">36.22</span> <span class="p">(</span><span class="n">Concurrency</span><span class="p">:</span>   <span class="mi">1</span><span class="p">)</span><span class="o">.</span> <span class="n">Average</span> <span class="n">task</span> <span class="n">time</span><span class="p">:</span> <span class="mf">3.1528</span> <span class="p">[</span> <span class="n">ms</span><span class="p">]</span><span class="o">.</span>
<span class="p">[</span><span class="n">sink</span><span class="p">]</span>       <span class="n">Processed</span>    <span class="mi">50</span> <span class="n">items</span> <span class="ow">in</span> <span class="mf">1.3814</span> <span class="p">[</span><span class="n">sec</span><span class="p">]</span><span class="o">.</span> <span class="n">QPS</span><span class="p">:</span> <span class="mf">36.20</span><span class="o">.</span> <span class="n">Average</span> <span class="n">wait</span> <span class="n">time</span><span class="p">:</span> <span class="n">Upstream</span><span class="p">:</span> <span class="mf">27.0740</span> <span class="p">[</span><span class="n">ms</span> <span class="p">],</span> <span class="n">Downstream</span><span class="p">:</span> <span class="mf">0.0041</span> <span class="p">[</span><span class="n">ms</span> <span class="p">]</span><span class="o">.</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">run_pipeline</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">download</span><span class="p">]</span>   <span class="n">Completed</span>  <span class="mi">1600</span> <span class="n">tasks</span> <span class="p">(</span>  <span class="mi">0</span> <span class="n">failed</span><span class="p">)</span> <span class="ow">in</span> <span class="mf">2.2429</span> <span class="p">[</span><span class="n">sec</span><span class="p">]</span><span class="o">.</span> <span class="n">QPS</span><span class="p">:</span> <span class="mf">713.36</span> <span class="p">(</span><span class="n">Concurrency</span><span class="p">:</span> <span class="mi">256</span><span class="p">)</span><span class="o">.</span> <span class="n">Average</span> <span class="n">task</span> <span class="n">time</span><span class="p">:</span> <span class="mf">154.0344</span> <span class="p">[</span> <span class="n">ms</span><span class="p">]</span><span class="o">.</span>
<span class="p">[</span><span class="n">decode_image</span><span class="p">]</span>       <span class="n">Completed</span>  <span class="mi">1600</span> <span class="n">tasks</span> <span class="p">(</span>  <span class="mi">0</span> <span class="n">failed</span><span class="p">)</span> <span class="ow">in</span> <span class="mf">2.2661</span> <span class="p">[</span><span class="n">sec</span><span class="p">]</span><span class="o">.</span> <span class="n">QPS</span><span class="p">:</span> <span class="mf">706.06</span> <span class="p">(</span><span class="n">Concurrency</span><span class="p">:</span>  <span class="mi">16</span><span class="p">)</span><span class="o">.</span> <span class="n">Average</span> <span class="n">task</span> <span class="n">time</span><span class="p">:</span> <span class="mf">14.4060</span> <span class="p">[</span> <span class="n">ms</span><span class="p">]</span><span class="o">.</span>
<span class="p">[</span><span class="n">aggregate</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="n">drop_last</span><span class="o">=</span><span class="kc">False</span><span class="p">)]</span>     <span class="n">Completed</span>  <span class="mi">1601</span> <span class="n">tasks</span> <span class="p">(</span>  <span class="mi">0</span> <span class="n">failed</span><span class="p">)</span> <span class="ow">in</span> <span class="mf">2.3514</span> <span class="p">[</span><span class="n">sec</span><span class="p">]</span><span class="o">.</span> <span class="n">QPS</span><span class="p">:</span> <span class="mf">680.86</span> <span class="p">(</span><span class="n">Concurrency</span><span class="p">:</span>   <span class="mi">1</span><span class="p">)</span><span class="o">.</span> <span class="n">Average</span> <span class="n">task</span> <span class="n">time</span><span class="p">:</span> <span class="mf">0.0039</span> <span class="p">[</span> <span class="n">ms</span><span class="p">]</span><span class="o">.</span>
<span class="p">[</span><span class="n">batchify</span><span class="p">]</span>   <span class="n">Completed</span>    <span class="mi">50</span> <span class="n">tasks</span> <span class="p">(</span>  <span class="mi">0</span> <span class="n">failed</span><span class="p">)</span> <span class="ow">in</span> <span class="mf">2.3610</span> <span class="p">[</span><span class="n">sec</span><span class="p">]</span><span class="o">.</span> <span class="n">QPS</span><span class="p">:</span> <span class="mf">21.18</span> <span class="p">(</span><span class="n">Concurrency</span><span class="p">:</span>   <span class="mi">1</span><span class="p">)</span><span class="o">.</span> <span class="n">Average</span> <span class="n">task</span> <span class="n">time</span><span class="p">:</span> <span class="mf">15.5912</span> <span class="p">[</span> <span class="n">ms</span><span class="p">]</span><span class="o">.</span>
<span class="p">[</span><span class="n">sink</span><span class="p">]</span>       <span class="n">Processed</span>    <span class="mi">50</span> <span class="n">items</span> <span class="ow">in</span> <span class="mf">2.3622</span> <span class="p">[</span><span class="n">sec</span><span class="p">]</span><span class="o">.</span> <span class="n">QPS</span><span class="p">:</span> <span class="mf">21.17</span><span class="o">.</span> <span class="n">Average</span> <span class="n">wait</span> <span class="n">time</span><span class="p">:</span> <span class="n">Upstream</span><span class="p">:</span> <span class="mf">46.3030</span> <span class="p">[</span><span class="n">ms</span> <span class="p">],</span> <span class="n">Downstream</span><span class="p">:</span> <span class="mf">0.0041</span> <span class="p">[</span><span class="n">ms</span> <span class="p">]</span><span class="o">.</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">run_pipeline</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="mi">32</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">download</span><span class="p">]</span>   <span class="n">Completed</span>  <span class="mi">1600</span> <span class="n">tasks</span> <span class="p">(</span>  <span class="mi">0</span> <span class="n">failed</span><span class="p">)</span> <span class="ow">in</span> <span class="mf">1.6766</span> <span class="p">[</span><span class="n">sec</span><span class="p">]</span><span class="o">.</span> <span class="n">QPS</span><span class="p">:</span> <span class="mf">954.30</span> <span class="p">(</span><span class="n">Concurrency</span><span class="p">:</span> <span class="mi">256</span><span class="p">)</span><span class="o">.</span> <span class="n">Average</span> <span class="n">task</span> <span class="n">time</span><span class="p">:</span> <span class="mf">156.4433</span> <span class="p">[</span> <span class="n">ms</span><span class="p">]</span><span class="o">.</span>
<span class="p">[</span><span class="n">decode_image</span><span class="p">]</span>       <span class="n">Completed</span>  <span class="mi">1600</span> <span class="n">tasks</span> <span class="p">(</span>  <span class="mi">0</span> <span class="n">failed</span><span class="p">)</span> <span class="ow">in</span> <span class="mf">1.6815</span> <span class="p">[</span><span class="n">sec</span><span class="p">]</span><span class="o">.</span> <span class="n">QPS</span><span class="p">:</span> <span class="mf">951.55</span> <span class="p">(</span><span class="n">Concurrency</span><span class="p">:</span>  <span class="mi">32</span><span class="p">)</span><span class="o">.</span> <span class="n">Average</span> <span class="n">task</span> <span class="n">time</span><span class="p">:</span> <span class="mf">18.5734</span> <span class="p">[</span> <span class="n">ms</span><span class="p">]</span><span class="o">.</span>
<span class="p">[</span><span class="n">aggregate</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="n">drop_last</span><span class="o">=</span><span class="kc">False</span><span class="p">)]</span>     <span class="n">Completed</span>  <span class="mi">1601</span> <span class="n">tasks</span> <span class="p">(</span>  <span class="mi">0</span> <span class="n">failed</span><span class="p">)</span> <span class="ow">in</span> <span class="mf">1.6862</span> <span class="p">[</span><span class="n">sec</span><span class="p">]</span><span class="o">.</span> <span class="n">QPS</span><span class="p">:</span> <span class="mf">949.48</span> <span class="p">(</span><span class="n">Concurrency</span><span class="p">:</span>   <span class="mi">1</span><span class="p">)</span><span class="o">.</span> <span class="n">Average</span> <span class="n">task</span> <span class="n">time</span><span class="p">:</span> <span class="mf">0.0039</span> <span class="p">[</span> <span class="n">ms</span><span class="p">]</span><span class="o">.</span>
<span class="p">[</span><span class="n">batchify</span><span class="p">]</span>   <span class="n">Completed</span>    <span class="mi">50</span> <span class="n">tasks</span> <span class="p">(</span>  <span class="mi">0</span> <span class="n">failed</span><span class="p">)</span> <span class="ow">in</span> <span class="mf">1.6866</span> <span class="p">[</span><span class="n">sec</span><span class="p">]</span><span class="o">.</span> <span class="n">QPS</span><span class="p">:</span> <span class="mf">29.64</span> <span class="p">(</span><span class="n">Concurrency</span><span class="p">:</span>   <span class="mi">1</span><span class="p">)</span><span class="o">.</span> <span class="n">Average</span> <span class="n">task</span> <span class="n">time</span><span class="p">:</span> <span class="mf">15.2163</span> <span class="p">[</span> <span class="n">ms</span><span class="p">]</span><span class="o">.</span>
<span class="p">[</span><span class="n">sink</span><span class="p">]</span>       <span class="n">Processed</span>    <span class="mi">50</span> <span class="n">items</span> <span class="ow">in</span> <span class="mf">1.6913</span> <span class="p">[</span><span class="n">sec</span><span class="p">]</span><span class="o">.</span> <span class="n">QPS</span><span class="p">:</span> <span class="mf">29.56</span><span class="o">.</span> <span class="n">Average</span> <span class="n">wait</span> <span class="n">time</span><span class="p">:</span> <span class="n">Upstream</span><span class="p">:</span> <span class="mf">33.1498</span> <span class="p">[</span><span class="n">ms</span> <span class="p">],</span> <span class="n">Downstream</span><span class="p">:</span> <span class="mf">0.0041</span> <span class="p">[</span><span class="n">ms</span> <span class="p">]</span><span class="o">.</span>
</pre></div>
</div>
<p>The following table summarizes the above result.</p>
<div class="table-wrapper right-align docutils container">
<table class="right-align docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Run</p></th>
<th class="head"><p>Download Concurrency</p></th>
<th class="head"><p>Decode Concurrency</p></th>
<th class="head"><p>Download QPS</p></th>
<th class="head"><p>Decoding QPS</p></th>
<th class="head"><p>Sink QPS (normalized)</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>1</p></td>
<td><p>64</p></td>
<td><p>4</p></td>
<td><p>255.09</p></td>
<td><p>254.93</p></td>
<td><p>254.72</p></td>
</tr>
<tr class="row-odd"><td><p>2</p></td>
<td><p>128</p></td>
<td><p>4</p></td>
<td><p>786.36</p></td>
<td><p>784.89</p></td>
<td><p>779.52</p></td>
</tr>
<tr class="row-even"><td><p>3</p></td>
<td><p>256</p></td>
<td><p>4</p></td>
<td><p>848.57</p></td>
<td><p>846.25</p></td>
<td><p>844.48</p></td>
</tr>
<tr class="row-odd"><td><p>4</p></td>
<td><p>512</p></td>
<td><p>4</p></td>
<td><p>802.31</p></td>
<td><p>800.55</p></td>
<td><p>798.40</p></td>
</tr>
<tr class="row-even"><td><p>5</p></td>
<td><p>256</p></td>
<td><p>8</p></td>
<td><p>1165.27</p></td>
<td><p>1162.10</p></td>
<td><p>1158.40</p></td>
</tr>
<tr class="row-odd"><td><p>6</p></td>
<td><p>256</p></td>
<td><p>16</p></td>
<td><p>713.36</p></td>
<td><p>706.06</p></td>
<td><p>677.44</p></td>
</tr>
<tr class="row-even"><td><p>7</p></td>
<td><p>256</p></td>
<td><p>32</p></td>
<td><p>954.30</p></td>
<td><p>951.55</p></td>
<td><p>945.92</p></td>
</tr>
</tbody>
</table>
</div>
<p>Looking at the first pipeline (<code class="docutils literal notranslate"><span class="pre">Run</span> <span class="pre">1</span></code>), we do not see a significant QPS drop in the stages.
It is around 241 at the beginning and the at the end of the pipeline.
This suggests that the first stage (download) is dominating the QPS of the whole pipeline.
So we increase the download concurrency.</p>
<p>As we increase the concurrency of download (<code class="docutils literal notranslate"><span class="pre">Run</span> <span class="pre">2</span> <span class="pre">-</span> <span class="pre">4</span></code>), QPS increases, but QPS is saturated
around 800.
Because the pipeline is automatically blocked according to the performance of the downstream,
we tweak the concurrency of decoding.
Increasing the decode concurrency from 4 to 8 (<code class="docutils literal notranslate"><span class="pre">Run</span> <span class="pre">5</span></code>), the QPS increases further more, but
it drops again beyond 16 (<code class="docutils literal notranslate"><span class="pre">Run</span> <span class="pre">6,</span> <span class="pre">7</span></code>).</p>
</section>
<section id="summary">
<h2>Summary<a class="headerlink" href="#summary" title="Link to this heading">¶</a></h2>
<p>When running <code class="xref py py-class docutils literal notranslate"><span class="pre">Pipeline</span></code>, <code class="xref py py-class docutils literal notranslate"><span class="pre">TaskStatsHook</span></code>: provides runtime statistics of stages. This information is helpful when determining which part of the pipeline should be optimized.</p>
</section>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="../migration/index.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">Usage Guide</div>
              </div>
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="bottleneck.html">
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">Is data loading bottleneck?</div>
                
              </div>
            </a>
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2025, Meta Platforms, Inc.
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            On this page
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">Which stage is the bottleneck?</a><ul>
<li><a class="reference internal" href="#task-stats-and-qps">Task Stats and QPS</a></li>
<li><a class="reference internal" href="#tuning-pipeline-performance">Tuning Pipeline Performance</a></li>
<li><a class="reference internal" href="#summary">Summary</a></li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div>
    <script src="../_static/js/custom.js"></script><script src="../_static/documentation_options.js?v=e2f847f2"></script>
    <script src="../_static/doctools.js?v=9a2dae69"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/scripts/furo.js?v=5fa4622c"></script>
    <script src="../_static/collapsible-lists/js/CollapsibleLists.compressed.js?v=73120307"></script>
    <script src="../_static/collapsible-lists/js/apply-collapsible-lists.js?v=660e4f45"></script>
    </body>
</html>